{% extends 'web/base.html' %}

{% block title %}{{ device.serial_number }} - IoT Platform{% endblock %}

{% block extra_css %}
<style>
    .capture-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
    }
    .capture-item {
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        background: #f3f4f6;
        position: relative;
        touch-action: pan-y;
    }
    .capture-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .motion-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        z-index: 10;
    }
    @media (max-width: 640px) {
        .capture-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    .swipe-container {
        position: relative;
        overflow: hidden;
    }
    .swipeable {
        touch-action: pan-y;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6 swipe-container">
    <!-- Back Button with Swipe Gesture -->
    <div class="flex items-center mb-4">
        <a href="{% url 'web:dashboard' %}" class="inline-flex items-center text-gray-600 hover:text-gray-900 touch-target">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Devices
        </a>
    </div>

    <!-- Device Header Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ device.serial_number }}</h1>
                <div class="flex items-center gap-2 flex-wrap">
                    {% if device.status == 'online' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                            Online
                        </span>
                    {% elif device.status == 'offline' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                            <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
                            Offline
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                            <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                            Maintenance
                        </span>
                    {% endif %}
                    
                    {% if device.power_state == 'awake' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-800">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            Active
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Battery Status -->
        {% if battery_voltage %}
        <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-semibold text-gray-900 mb-1">Battery Status</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-bold text-gray-900">{{ battery_voltage|floatformat:2 }}V</span>
                        {% if solar_charging %}
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                                </svg>
                                Solar Charging
                            </span>
                        {% endif %}
                    </div>
                    <!-- Battery Level Indicator -->
                    <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                        {% if battery_voltage >= 3.8 %}
                            <div class="bg-green-500 h-2 rounded-full" style="width: 90%"></div>
                        {% elif battery_voltage >= 3.5 %}
                            <div class="bg-yellow-500 h-2 rounded-full" style="width: 60%"></div>
                        {% elif battery_voltage >= 3.3 %}
                            <div class="bg-orange-500 h-2 rounded-full" style="width: 30%"></div>
                        {% else %}
                            <div class="bg-red-500 h-2 rounded-full" style="width: 10%"></div>
                        {% endif %}
                    </div>
                    {% if battery_voltage < 3.3 %}
                        <p class="text-xs text-red-600 mt-1">⚠️ Low battery - consider charging</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Device Stats -->
        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200">
            <div>
                <p class="text-xs text-gray-500 mb-1">Last Seen</p>
                <p class="text-sm font-medium text-gray-900" id="last-seen">{{ device.last_seen|timesince }} ago</p>
            </div>
            <div>
                <p class="text-xs text-gray-500 mb-1">Total Captures</p>
                <p class="text-sm font-medium text-gray-900" id="total-captures">
                    {% if device.captures.exists %}
                        {{ device.captures.count }}
                    {% else %}
                        {{ recent_captures|length }}
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Live Feed Viewer -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Live Feed</h2>
        <div class="bg-gray-900 rounded-lg aspect-video flex items-center justify-center relative overflow-hidden">
            {% if recent_captures %}
                {% with first_capture=recent_captures.0 %}
                    <img id="liveFeed" 
                         src="data:image/jpeg;base64,{% if first_capture.image_base64 %}{{ first_capture.image_base64 }}{% else %}{{ first_capture.image }}{% endif %}" 
                         alt="Live feed" 
                         class="max-w-full max-h-full object-contain">
                {% endwith %}
            {% else %}
                <div class="text-gray-500 text-center">
                    <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    <p class="text-sm">No captures yet</p>
                </div>
            {% endif %}
            <div class="absolute top-2 right-2">
                <span id="live-badge" class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-red-600 text-white">
                    <span class="w-1.5 h-1.5 bg-white rounded-full mr-1.5 animate-pulse"></span>
                    LIVE
                </span>
            </div>
        </div>
    </div>

    <!-- Device Location & Setup Guide -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Device Setup & Location</h2>
        
        <div class="space-y-4">
            <!-- Setup Steps -->
            <div class="border-l-4 border-blue-500 pl-4">
                <h3 class="font-semibold text-gray-900 mb-2">Setup Guide</h3>
                <ol class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-start gap-2">
                        <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">1</span>
                        <span>Mount device in mailbox with camera facing mail slot</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">2</span>
                        <span>Connect IR sensor to GPIO 13 for mail detection</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">3</span>
                        <span>Install reed switch on GPIO 12 for door state</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">4</span>
                        <span>Connect battery and solar panel (optional)</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">5</span>
                        <span>Device will enter deep sleep to save battery</span>
                    </li>
                </ol>
            </div>
            
            <!-- Location Notes -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Location Notes
                </h3>
                <p class="text-sm text-gray-600 mb-2">Record your device location for reference:</p>
                <textarea id="location-notes" 
                          placeholder="e.g., Front door mailbox, facing east, mounted 6 inches from top..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          rows="3"></textarea>
                <button onclick="saveLocationNotes()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                    Save Location
                </button>
            </div>
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-3">
                <a href="{% url 'web:claim_device' %}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium text-center hover:bg-gray-200">
                    Re-setup Device
                </a>
                <button onclick="testDevice()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                    Test Connection
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Captures Grid -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Recent Captures</h2>
            <div class="flex items-center gap-2">
                <button onclick="saveAllCapturesToDevice()" 
                        class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 touch-target">
                    Save All
                </button>
                <a href="{% url 'web:photo_gallery' device.serial_number %}" class="text-sm text-blue-600 font-medium">View All →</a>
            </div>
        </div>
        
        {% if recent_captures %}
            <div class="capture-grid" id="capture-grid">
                {% for capture in recent_captures %}
                <div class="capture-item group cursor-pointer swipeable" 
                     data-capture-id="{{ capture.id }}"
                     onclick="showImage('{{ capture.id }}', '{% if capture.image_base64 %}{{ capture.image_base64 }}{% else %}{{ capture.image }}{% endif %}')">
                    <img src="data:image/jpeg;base64,{% if capture.image_base64 %}{{ capture.image_base64 }}{% else %}{{ capture.image }}{% endif %}" 
                         alt="Capture {{ capture.id }}" 
                         loading="lazy"
                         class="transition-transform group-hover:scale-105"
                         onload="autoSaveToDevice('{{ capture.id }}', this.src)">
                    {% if capture.motion_detected %}
                        <div class="motion-badge">MOTION</div>
                    {% endif %}
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <div class="flex items-center justify-between">
                            <p class="text-white text-xs">
                                {% if capture.timestamp %}
                                    {{ capture.timestamp|date:"H:i" }}
                                {% else %}
                                    {{ capture.captured_at|date:"H:i" }}
                                {% endif %}
                            </p>
                            <button onclick="event.stopPropagation(); downloadCapture('{{ capture.id }}')" 
                                    class="ml-2 p-1 bg-white/20 hover:bg-white/30 rounded touch-target">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <p class="text-gray-600 text-sm">No captures available</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4" onclick="closeModal()">
    <div class="max-w-4xl w-full relative">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10 touch-target p-2">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        <div class="absolute top-4 left-4 flex gap-2 z-10">
            <button id="downloadBtn" onclick="event.stopPropagation(); downloadCurrentImage()" 
                    class="p-3 bg-white/20 hover:bg-white/30 rounded-lg touch-target">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
            </button>
            <button id="saveBtn" onclick="event.stopPropagation(); saveCurrentImageToDevice()" 
                    class="p-3 bg-white/20 hover:bg-white/30 rounded-lg touch-target">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </button>
        </div>
        <img id="modalImage" src="" alt="Full size capture" class="max-w-full max-h-full object-contain" onclick="event.stopPropagation()">
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const deviceSerial = '{{ device_serial|default:device.serial_number }}';
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsHost = window.location.host;
    const wsUrl = `${wsProtocol}//${wsHost}/ws/device/${deviceSerial}/`;
    
    let websocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    
    // Swipe gesture handling
    let touchStartX = 0;
    let touchEndX = 0;
    const swipeThreshold = 50;
    
    function handleSwipe() {
        const swipeDistance = touchEndX - touchStartX;
        if (Math.abs(swipeDistance) > swipeThreshold) {
            if (swipeDistance > 0) {
                // Swipe right - go back
                window.location.href = "{% url 'web:dashboard' %}";
            }
        }
    }
    
    document.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });
    
    document.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, { passive: true });
    
    function connectWebSocket() {
        try {
            console.log(`Attempting to connect WebSocket: ${wsUrl}`);
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(e) {
                console.log('WebSocket connected successfully');
                reconnectAttempts = 0;
                updateConnectionStatus(true);
                showNotification('Connected to live feed', 'success', 2000);
            };
            
            websocket.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    handleWebSocketMessage(data);
                } catch (parseError) {
                    console.error('Error parsing WebSocket message:', parseError, e.data);
                }
            };
            
            websocket.onerror = function(e) {
                console.error('WebSocket error:', e);
                updateConnectionStatus(false);
                // Don't show error notification on every error to avoid spam
                // The onclose handler will show a reconnection message
            };
            
            websocket.onclose = function(e) {
                console.log(`WebSocket disconnected. Code: ${e.code}, Reason: ${e.reason || 'No reason provided'}`);
                updateConnectionStatus(false);
                
                // Attempt to reconnect with exponential backoff
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(2000 * Math.pow(2, reconnectAttempts - 1), 30000); // Max 30 seconds
                    console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                    
                    if (reconnectAttempts === 1) {
                        showNotification('Connection lost. Reconnecting...', 'info', 3000);
                    }
                    
                    setTimeout(connectWebSocket, delay);
                } else {
                    console.error('Max reconnection attempts reached');
                    showNotification('Failed to reconnect. Please refresh the page.', 'error', 5000);
                }
            };
        } catch (error) {
            console.error('Failed to connect WebSocket:', error);
            updateConnectionStatus(false);
            showNotification('Failed to connect to live feed', 'error', 3000);
        }
    }
    
    function handleWebSocketMessage(data) {
        if (data.type === 'new_capture') {
            // Show popup notification for manual triggers
            if (data.trigger_type === 'manual') {
                showManualTriggerNotification(data);
            } else {
                showNotification('New capture received', 'success', 3000);
            }
            
            // Update live feed
            const liveFeedImg = document.getElementById('liveFeed');
            if (liveFeedImg && data.image) {
                liveFeedImg.src = 'data:image/jpeg;base64,' + data.image;
                // Add fade-in effect
                liveFeedImg.style.opacity = '0';
                setTimeout(() => {
                    liveFeedImg.style.transition = 'opacity 0.3s';
                    liveFeedImg.style.opacity = '1';
                }, 10);
            }
            
            // Auto-refresh capture grid by adding new capture
            addCaptureToGrid(data);
            
            // Update device status if provided
            // Update trigger type badge if needed
            if (data.trigger_type === 'manual') {
                updateTriggerBadge('manual');
            }
            
            // Update device status badge if provided
            if (data.device_status) {
                updateDeviceStatusBadge(data.device_status);
            }
        } else if (data.type === 'connection') {
            console.log('WebSocket:', data.message);
            // Connection confirmation - no notification needed
        } else if (data.type === 'error') {
            console.error('WebSocket error message:', data.message);
            showNotification(data.message || 'An error occurred', 'error', 3000);
        }
    }
    
    function addCaptureToGrid(captureData) {
        const grid = document.getElementById('capture-grid');
        if (!grid) return;
        
        // Create new capture item
        const captureItem = document.createElement('div');
        captureItem.className = 'capture-item group cursor-pointer swipeable';
        captureItem.setAttribute('data-capture-id', captureData.capture_id);
        captureItem.onclick = () => showImageFromData(captureData.image);
        
        const img = document.createElement('img');
        img.src = 'data:image/jpeg;base64,' + captureData.image;
        img.alt = 'Capture ' + captureData.capture_id;
        img.loading = 'lazy';
        img.className = 'transition-transform group-hover:scale-105';
        
        const overlay = document.createElement('div');
        overlay.className = 'absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity';
        const timeStr = captureData.captured_at ? new Date(captureData.captured_at).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : 'Just now';
        overlay.innerHTML = `<p class="text-white text-xs">${timeStr}</p>`;
        
        captureItem.appendChild(img);
        
        // Add trigger type badge
        const triggerBadge = document.createElement('div');
        triggerBadge.className = captureData.trigger_type === 'manual' 
            ? 'inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 ml-2'
            : 'inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800 ml-2';
        triggerBadge.textContent = captureData.trigger_type === 'manual' ? 'MANUAL' : 'AUTO';
        captureItem.appendChild(triggerBadge);
        
        captureItem.appendChild(overlay);
        
        // Insert at the beginning of the grid
        grid.insertBefore(captureItem, grid.firstChild);
        
        // Update count
        const countElement = document.getElementById('capture-count');
        if (countElement) {
            const currentCount = parseInt(countElement.textContent) || 0;
            countElement.textContent = (currentCount + 1) + ' images';
        }
        
        // Update total captures
        const totalCaptures = document.getElementById('total-captures');
        if (totalCaptures) {
            const currentTotal = parseInt(totalCaptures.textContent) || 0;
            totalCaptures.textContent = currentTotal + 1;
        }
    }
    
    let currentCaptureId = null;
    let currentImageData = null;
    
    // IndexedDB for local storage
    let db = null;
    const DB_NAME = 'SmartCameraPhotos';
    const DB_VERSION = 1;
    const STORE_NAME = 'captures';
    
    function initIndexedDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                    store.createIndex('deviceSerial', 'deviceSerial', { unique: false });
                }
            };
        });
    }
    
    // Auto-save image to IndexedDB when loaded
    async function autoSaveToDevice(captureId, imageSrc) {
        try {
            if (!db) {
                await initIndexedDB();
            }
            // Extract base64 data from src
            const base64Data = imageSrc.replace('data:image/jpeg;base64,', '');
            await saveImageToIndexedDB(captureId, base64Data);
        } catch (error) {
            console.log('Auto-save failed (non-critical):', error);
        }
    }
    
    // Save image to IndexedDB
    async function saveImageToIndexedDB(captureId, base64Data) {
        try {
            if (!db) {
                await initIndexedDB();
            }
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            
            const captureData = {
                id: captureId,
                image: base64Data,
                timestamp: new Date().toISOString(),
                deviceSerial: deviceSerial
            };
            
            await store.put(captureData);
            console.log(`Saved capture ${captureId} to local storage`);
        } catch (error) {
            console.error('Error saving to IndexedDB:', error);
        }
    }
    
    // Download capture from server
    function downloadCapture(captureId) {
        const url = `/capture/${captureId}/download/`;
        const link = document.createElement('a');
        link.href = url;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('Photo downloading...', 'success', 2000);
    }
    
    // Download base64 image directly
    function downloadBase64Image(base64Data) {
        try {
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/jpeg' });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `capture_${deviceSerial}_${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Photo saved to device!', 'success', 2000);
        } catch (error) {
            console.error('Error downloading image:', error);
            showNotification('Error saving photo', 'error', 3000);
        }
    }
    
    // Download current image from modal
    function downloadCurrentImage() {
        if (currentCaptureId) {
            downloadCapture(currentCaptureId);
        } else if (currentImageData) {
            downloadBase64Image(currentImageData);
        }
    }
    
    // Save current image to device (IndexedDB + download)
    async function saveCurrentImageToDevice() {
        if (currentCaptureId && currentImageData) {
            await saveImageToIndexedDB(currentCaptureId, currentImageData);
            downloadBase64Image(currentImageData);
        }
    }
    
    // Save all captures to device
    async function saveAllCapturesToDevice() {
        showNotification('Saving all photos to device...', 'info', 2000);
        
        try {
            if (!db) {
                await initIndexedDB();
            }
            
            const captureItems = document.querySelectorAll('.capture-item[data-capture-id]');
            let savedCount = 0;
            
            for (const item of captureItems) {
                const captureId = item.getAttribute('data-capture-id');
                const img = item.querySelector('img');
                if (img && img.src) {
                    const base64Data = img.src.replace('data:image/jpeg;base64,', '');
                    await saveImageToIndexedDB(captureId, base64Data);
                    savedCount++;
                }
            }
            
            showNotification(`Saved ${savedCount} photos to device!`, 'success', 3000);
        } catch (error) {
            console.error('Error saving all captures:', error);
            showNotification('Error saving photos', 'error', 3000);
        }
    }
    
    function showImageFromData(imageData) {
        currentCaptureId = null;
        currentImageData = imageData;
        document.getElementById('modalImage').src = 'data:image/jpeg;base64,' + imageData;
        document.getElementById('imageModal').classList.remove('hidden');
    }
    
    function showImage(captureId, imageData) {
        currentCaptureId = captureId;
        currentImageData = imageData;
        document.getElementById('modalImage').src = 'data:image/jpeg;base64,' + imageData;
        document.getElementById('imageModal').classList.remove('hidden');
        // Auto-save to device when viewing
        saveImageToIndexedDB(captureId, imageData);
    }
    
    function updateMotionBadge(show) {
        let badge = document.getElementById('motion-badge');
        if (show && !badge) {
            // Create motion badge if it doesn't exist
            const headerDiv = document.querySelector('.flex.items-center.gap-2');
            if (headerDiv) {
                badge = document.createElement('span');
                badge.id = 'motion-badge';
                badge.className = 'inline-flex items-center px-3 py-1 rounded-md text-sm font-medium bg-red-100 text-red-800';
                badge.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    Motion Detected
                `;
                headerDiv.appendChild(badge);
            }
        }
    }
    
    // Location notes functions
    function saveLocationNotes() {
        const notes = document.getElementById('location-notes').value;
        localStorage.setItem('device-location-{{ device.serial_number }}', notes);
        showNotification('Location notes saved!', 'success');
    }
    
    // Load saved location notes
    window.addEventListener('DOMContentLoaded', function() {
        const savedNotes = localStorage.getItem('device-location-{{ device.serial_number }}');
        if (savedNotes) {
            document.getElementById('location-notes').value = savedNotes;
        }
    });
    
    // Test device connection
    function testDevice() {
        showNotification('Testing device connection...', 'info');
        // You can implement actual device ping/test here
        setTimeout(() => {
            showNotification('Device is online and responding', 'success');
        }, 1000);
    }
    
    function showNotification(message, type = 'info', duration = 3000) {
        // Remove any existing notifications first
        const existingNotifications = document.querySelectorAll('.ws-notification');
        existingNotifications.forEach(n => n.remove());
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'ws-notification fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full';
        
        // Set color based on type
        if (type === 'success') {
            notification.classList.add('bg-green-500');
        } else if (type === 'error') {
            notification.classList.add('bg-red-500');
        } else if (type === 'warning') {
            notification.classList.add('bg-yellow-500');
        } else {
            notification.classList.add('bg-blue-500');
        }
        
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 10);
        
        // Remove after duration
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }, duration);
    }
    
    function showMotionNotification(captureData) {
        // Create prominent motion detection notification
        const notification = document.createElement('div');
        notification.className = 'ws-notification fixed top-4 left-4 right-4 z-50 px-4 py-4 rounded-lg shadow-xl bg-red-600 text-white transform transition-all duration-300 -translate-y-full';
        
        notification.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="flex-shrink-0">
                    <svg class="w-6 h-6 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-lg">Motion Detected!</p>
                    <p class="text-sm opacity-90">New capture from ${deviceSerial}</p>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('-translate-y-full');
        }, 10);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.classList.add('-translate-y-full');
            setTimeout(() => notification.remove(), 300);
        }, 5000);
        
        // Play notification sound if available (optional)
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OSfTQ8OUKbj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDkn00PDlCm4/C2YxwGOJHX8sx5LAUkd8fw3ZBAC');
            audio.volume = 0.3;
            audio.play().catch(e => console.log('Could not play notification sound:', e));
        } catch (e) {
            // Ignore audio errors
        }
    }
    
    function updateDeviceStatusBadge(status) {
        // Update device status badge in header if needed
        const statusBadges = document.querySelectorAll('.inline-flex.items-center');
        // This could be enhanced to specifically update the status badge
    }
    
    function updateConnectionStatus(connected) {
        const liveBadge = document.getElementById('live-badge');
        if (liveBadge) {
            if (connected) {
                liveBadge.classList.remove('bg-gray-500');
                liveBadge.classList.add('bg-red-600');
            } else {
                liveBadge.classList.remove('bg-red-600');
                liveBadge.classList.add('bg-gray-500');
            }
        }
    }
    
    function closeModal() {
        document.getElementById('imageModal').classList.add('hidden');
    }
    
    // Initialize IndexedDB on page load
    window.addEventListener('load', function() {
        initIndexedDB().catch(err => console.log('IndexedDB init failed (non-critical):', err));
        // Small delay to ensure page is fully loaded
        setTimeout(connectWebSocket, 500);
    });
    
    // Reconnect when page becomes visible (if disconnected)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && (!websocket || websocket.readyState === WebSocket.CLOSED)) {
            console.log('Page visible, reconnecting WebSocket...');
            reconnectAttempts = 0; // Reset attempts
            connectWebSocket();
        }
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (websocket) {
            websocket.close(1000, 'Page unloading');
        }
    });
    
    // Handle page visibility for better connection management
    if (document.hidden && websocket) {
        websocket.close(1000, 'Page hidden');
    }
</script>
{% endblock %}
