<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Monitor and manage your Smart Camera devices">
    
    <!-- Apple iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SmartCamera">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/static/icons/icon-512x512.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-TileImage" content="/static/icons/icon-192x192.png">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
    
    <title>{% block title %}SmartCamera - IoT Platform{% endblock %}</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% url 'web:manifest' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for native app feel */
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .content-wrapper {
            padding-bottom: 80px; /* Space for bottom nav */
        }
        
        /* Dark mode styles */
        body.dark-mode {
            background-color: #1f2937;
            color: #f9fafb;
        }
        body.dark-mode .bottom-nav {
            background: #111827;
            border-top-color: #374151;
        }
        body.dark-mode .bg-white {
            background-color: #1f2937 !important;
        }
        body.dark-mode .text-gray-900 {
            color: #f9fafb !important;
        }
        body.dark-mode .text-gray-600 {
            color: #d1d5db !important;
        }
        body.dark-mode .border-gray-200 {
            border-color: #374151 !important;
        }
        
        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            padding: 8px;
            text-align: center;
            z-index: 100;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .offline-indicator.show {
            transform: translateY(0);
        }
        
        /* Pull to refresh */
        .pull-to-refresh {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: #667eea;
            font-size: 14px;
            transition: top 0.3s ease;
        }
        .pull-to-refresh.active {
            top: 10px;
        }
        
        /* Touch-friendly targets */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50">
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        <span>⚠️ You're offline. Some features may not work.</span>
    </div>
    
    <!-- Dark Mode Toggle -->
    <button id="dark-mode-toggle" class="fixed top-4 right-4 z-50 p-2 bg-white dark:bg-gray-800 rounded-full shadow-lg hover:shadow-xl transition-shadow" aria-label="Toggle dark mode">
        <svg id="sun-icon" class="w-6 h-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
        </svg>
        <svg id="moon-icon" class="w-6 h-6 text-gray-700" fill="currentColor" viewBox="0 0 20 20">
            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
        </svg>
    </button>
    
    <div class="content-wrapper min-h-screen">
        {% block content %}{% endblock %}
    </div>
    
    <!-- Bottom Navigation -->
    {% if user.is_authenticated %}
    <nav class="bottom-nav">
        <div class="flex justify-around items-center h-16">
            <a href="{% url 'web:dashboard' %}" class="flex flex-col items-center justify-center flex-1 h-full touch-target {% if request.resolver_match.url_name == 'dashboard' %}text-blue-600{% else %}text-gray-500{% endif %}">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs">Home</span>
            </a>
            <a href="{% url 'web:photo_gallery' %}" class="flex flex-col items-center justify-center flex-1 h-full touch-target {% if 'gallery' in request.resolver_match.url_name %}text-blue-600{% else %}text-gray-500{% endif %}">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-xs">Gallery</span>
            </a>
            <a href="{% url 'web:claim_device' %}" class="flex flex-col items-center justify-center flex-1 h-full touch-target {% if request.resolver_match.url_name == 'claim_device' %}text-blue-600{% else %}text-gray-500{% endif %}">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <span class="text-xs">Add</span>
            </a>
            <a href="{% url 'web:settings' %}" class="flex flex-col items-center justify-center flex-1 h-full touch-target {% if request.resolver_match.url_name == 'settings' %}text-blue-600{% else %}text-gray-500{% endif %}">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-xs">Settings</span>
            </a>
        </div>
    </nav>
    {% endif %}
    
    {% block extra_js %}{% endblock %}
    
    <!-- Dark Mode Toggle Script -->
    <script>
        // Dark mode functionality
        (function() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const body = document.body;
            
            // Load saved theme preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
            
            if (isDark) {
                body.classList.add('dark-mode');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            
            // Toggle dark mode
            darkModeToggle.addEventListener('click', function() {
                body.classList.toggle('dark-mode');
                const isDarkMode = body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                
                if (isDarkMode) {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
            });
        })();
    </script>
    
    <!-- Offline Indicator Script -->
    <script>
        (function() {
            const offlineIndicator = document.getElementById('offline-indicator');
            
            function updateOnlineStatus() {
                if (navigator.onLine) {
                    offlineIndicator.classList.remove('show');
                } else {
                    offlineIndicator.classList.add('show');
                }
            }
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus(); // Initial check
        })();
    </script>
    
    <!-- Service Worker Registration and Push Subscription -->
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('{% url "web:service_worker" %}', {
                    scope: '/'
                })
                    .then(function(registration) {
                        console.log('Service Worker registered successfully:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, prompt user to refresh
                                    if (confirm('A new version is available. Refresh to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                        
                        // Handle service worker updates
                        let refreshing = false;
                        navigator.serviceWorker.addEventListener('controllerchange', function() {
                            if (!refreshing) {
                                refreshing = true;
                                window.location.reload();
                            }
                        });
                        
                        // Request notification permission and subscribe to push
                        if ('Notification' in window) {
                            if (Notification.permission === 'default') {
                                Notification.requestPermission().then(function(permission) {
                                    if (permission === 'granted') {
                                        subscribeToPush(registration);
                                    }
                                });
                            } else if (Notification.permission === 'granted') {
                                subscribeToPush(registration);
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        } else {
            console.warn('Service Workers are not supported in this browser');
        }
        
        function subscribeToPush(registration) {
            registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array('{{ VAPID_PUBLIC_KEY|default:"" }}')
            })
            .then(function(subscription) {
                // Send subscription to server
                fetch('{% url "web:subscribe_push" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(subscription.toJSON())
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    console.log('Push subscription registered:', data);
                })
                .catch(function(error) {
                    console.error('Error registering push subscription:', error);
                });
            })
            .catch(function(error) {
                console.error('Error subscribing to push:', error);
            });
        }
        
        function urlBase64ToUint8Array(base64String) {
            if (!base64String) return null;
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>

